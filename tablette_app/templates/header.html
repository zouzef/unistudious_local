<!-- ============================= -->
<!-- HEADER SECTION -->
<!-- ============================= -->
<header class="top-header bg-white border-bottom">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center py-2">
            <div class="d-flex align-items-center">
                <img src="" alt="Logo" width="70" height="65" id="academy-logo" style="border-radius:10px">
            <h1 class="h2 mb-0" id="name-academie" style="padding-left: 5px;"></h1>

            </div>

            <div class="d-flex align-items-center">
                <!-- Statistics Button -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary d-flex align-items-center" type="button"
                        style="background-color: #5a47cf; color: white; border:none;"
                        data-bs-toggle="modal" data-bs-target="#model-stat">
                        <i class="fas fa-chart-pie me-2"></i> Statistique
                    </button>
                </div>

                <!-- Unknown Students Button -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary d-flex align-items-center" type="button"
                        style="background-color: rgb(253, 83, 83); color: white; border:none;"
                        onclick="getUnknownStudent()">
                        <i class="fa-solid fa-circle-exclamation" style="padding-right:5px"></i> Unknown Students
                    </button>
                </div>

                <!-- Reset Attendance Button -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary d-flex align-items-center" id="reset_attendance_id"
                        type="button" style="background-color: rgb(252, 205, 91); color: white; border:none;">
                        <i class="fas fa-sync-alt me-2"></i> Reset Attendance
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- ============================= -->
<!-- MODALS SECTION -->
<!-- ============================= -->

<!-- Statistics Modal -->
<div class="modal fade" id="model-stat" tabindex="-1" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Statistique Attendance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="attendanceChart"></canvas>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Teacher Attendance Modal (Commented Out) -->
<!--
<div class="modal fade" id="model-attendance-teacher" tabindex="-1" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalCenterTitle">Modal title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>
-->

<!-- Unknown Students Modal -->
<div class="modal fade" id="model-unknown-student" tabindex="-1" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="color: rgb(77, 68, 181);">Unknown Students</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <div class="custom-alert-danger">
                  <i class="fas fa-exclamation-triangle"></i>
                    <span>Please delete blurry images and images that don't belong to the person before associating</span>              </div>
      <div class="modal-body" style="background-color: rgb(248, 249, 250);">
        <!-- Dynamic content will be inserted here -->
      </div>
    </div>
  </div>
</div>

<!-- Set Known Student Modal -->
<div class="modal fade" id="modal-set-known" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" style="color: rgb(77, 68, 181)">Set Known Student</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>


              <div class="table-responsive">
                  <table class="table table-hover" border="1px">

                      <thead>
                          <tr>
                            <th scope="col">Student Name</th>
                            <th scope="col">Email</th>
                            <th scope="col">Action</th>
                          </tr>
                      </thead>
                      <tbody id="students-table-body">
                          <!-- Dynamic content will be inserted here -->
                      </tbody>
                  </table>
              </div>

              <!-- Pagination Container -->
              <div class="pagination-container">
                  <div class="pagination-info" id="pagination-info">
                      <!-- Pagination info will be inserted here -->
                  </div>
                  <nav aria-label="Student pagination">
                      <ul class="pagination pagination-sm mb-0" id="pagination-controls">
                          <!-- Pagination controls will be inserted here -->
                      </ul>
                  </nav>
              </div>
            </div>
          </div>
    </div>
</div>

<!-- ============================= -->
<!-- STYLES SECTION -->
<!-- ============================= -->
<style>

    /* ✅ Custom alert styling - ADD THIS */
    .custom-alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c2c7;
        border-left: 4px solid #dc3545;
        color: #842029;
        padding: 12px 16px;
        border-radius: 6px;
        margin: 15px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        font-size: 14px;
    }

    .custom-alert-danger i {
        font-size: 18px;
        margin-right: 10px;
        color: #dc3545;
    }

    .custom-alert-danger span {
        font-weight: 500;
    }

    /* Button Styles */
    .btn-associate {
        background-color: #6f42c1;
        border-color: #6f42c1;
        color: white;
        font-weight: 500;
        padding: 6px 20px;
        border-radius: 6px;
        font-size: 14px;
    }
    .btn-associate:hover {
        background-color: #5a2d91;
        border-color: #5a2d91;
        color: white;
    }

    .btn-delete {
        background-color: rgb(253, 83, 83);
        color: #fff;
        border: none;
        padding: 6px 14px;
        border-radius: 6px;
        transition: background 0.2s ease;
    }
    .btn-delete:hover {
        background-color: #c0392b;
    }

    .btn-unknown {
        background-color: #28a745;
        color: #fff;
        border: none;
        padding: 6px 14px;
        border-radius: 6px;
        transition: background 0.2s ease;
    }
    .btn-unknown:hover {
        background-color: #28a7468f;
    }

    /*images style*/
    #academy-logo{
        border-raduis:50px;

    }



    /* Table Styles */
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding: 15px;
        font-size: 14px;
    }
    .table td {
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid #dee2e6;
        font-size: 14px;
    }
    .student-name {
        font-weight: 500;
        color: #495057;
    }
    .student-email {
        color: #6c757d;
    }
    .table {
        margin-bottom: 0;
    }

    /* Pagination Styles */
    .pagination-container {
        margin-top: 15px;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    .pagination-info {
        font-size: 14px;
        color: #6c757d;
    }
    .page-item.active .page-link {
        background-color: #6f42c1;
        border-color: #6f42c1;
    }


    //Style for delete icon on images
    /* Image wrapper with delete button */
    .image-wrapper {
        position: relative;
        display: inline-block;
    }

    .image-delete-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 28px;
        height: 28px;
        border-radius: 4px; /* ✅ Small border radius instead of circle */
        background-color: rgba(220, 53, 69, 0.9);
        color: white;
        border: 2px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        padding: 0;
        transition: all 0.2s ease;
        z-index: 10;
    }

    .image-delete-btn:hover {
        background-color: rgba(200, 35, 51, 1);
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .image-delete-btn i {
        pointer-events: none;
    }


    /* Custom SweetAlert2 styling */
    .custom-swal-popup {
        border-radius: 15px !important;
        padding: 30px !important;
    }

    .custom-swal-title {
        color: #495057 !important;
        font-size: 24px !important;
        font-weight: 600 !important;
    }

    .custom-swal-text {
        color: #6c757d !important;
        font-size: 16px !important;
    }
</style>

<!-- ============================= -->
<!-- SCRIPTS SECTION -->
<!-- ============================= -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// =============================
// GLOBAL VARIABLES
// =============================
let attendanceChart; // Global chart reference for statistics
let currentPage = 1; // Current page for pagination
let studentsPerPage = 5; // Number of students per page
let allStudents = []; // Array to store all students
let currentFolder = ""; // Current folder path for unknown students

// =============================
// INITIALIZATION FUNCTIONS
// =============================

/**
 * Initialize the page when DOM is loaded
 * Fetches academy name and sets up event listeners
 */
document.addEventListener("DOMContentLoaded", function () {
    // Fetch academy data
    fetch(`/get-data-account/${sessionId}`)
    .then(res => {
        if (!res.ok) {
            throw new Error("Failed to load session data");
        }
        return res.json();
    })
    .then(response => {
        if (response.data && response.data.length > 0) {
            // Set the academy name from the first item
            const academyName = response.data[0].name;
            document.getElementById("name-academie").innerHTML = academyName;

                // Set the dynamic logo image
                const logoFilename = response.data[0].file_link; // e.g., "screenshot-20240923-103624-66f136ec8f029999937969.jpg"
                console.log(logoFilename);
                if (logoFilename) {
                    // Use the dynamic path for the image
                    document.getElementById("academy-logo").src = `../static/assets/images/${logoFilename}`;

                } else {
                    console.log("No logo filename found in response");
                }
            } else {
                console.log("No data found in API response");
        }
    })
    .catch(error => {
        console.error("Error fetching session data:", error);
        showNotification("An error occurred while fetching attendance data.", "warning");
    });

    // Set up statistics modal event listener
    document.getElementById("model-stat").addEventListener("shown.bs.modal", function () {
        get_statics_attendance();
    });

    // Set up reset attendance button event listener
    document.getElementById("reset_attendance_id").addEventListener("click", reset_attendance);
});

// =============================
// STATISTICS FUNCTIONS
// =============================

/**
 * Fetch attendance statistics and display chart
 */
function get_statics_attendance() {
    fetch(`/get-statics-attendance/${sessionId}`)
        .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
        })
        .then(result => {
            showAttendanceChart(result.data.present, result.data.absent);
        })
        .catch(err => {
            console.error("Error fetching statics attendance:", err);
            showNotification("An error occurred while fetching the statics attendance.", 'warning');
        });
}

/**
 * Display attendance statistics as a pie chart
 * @param {number} present - Number of present students
 * @param {number} absent - Number of absent students
 */
function showAttendanceChart(present, absent) {
    const ctx = document.getElementById('attendanceChart').getContext('2d');

    // Destroy existing chart if opened multiple times
    if (attendanceChart) {
        attendanceChart.destroy();
    }

    attendanceChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Present', 'Absent'],
            datasets: [{
                data: [present, absent],
                backgroundColor: ['#a0e7e5', '#ffb3b3'],
                borderColor: ['#5adbb5', '#ff6b6b'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            return `${label}: ${value}`;
                        }
                    }
                }
            }
        }
    });
}

// =============================
// UNKNOWN STUDENTS FUNCTIONS
// =============================

/**
 * Fetch and display unknown students in a modal
 */
function getUnknownStudent() {
    fetch(`/api/show-attendance-unknown/${sessionId}`)
        .then(res => {
            if (!res.ok) {
                throw new Error("Failed to load session data");
            }
            return res.json();
        })
        .then(data => {
            const grouped = data["unknownFilesGrouped"];

            if (!grouped || Object.keys(grouped).length === 0) {
                showNotification('No unknown students found', 'info');
                return;
            }

            const modalBody = document.querySelector("#model-unknown-student .modal-body");
            modalBody.innerHTML = ""; // Clear old content

            // Create UI for each folder of unknown students
            for (const folder in grouped) {
                const folderDiv = createFolderUI(folder, grouped[folder]);
                modalBody.appendChild(folderDiv);
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('model-unknown-student'));
            modal.show();
        })
        .catch(err => {
            console.error("Error loading session data:", err);
            showNotification('Error loading session data', 'warning');
        });
}

/**
 * Create UI for a folder of unknown students
 * @param {string} folder - Folder path
 * @param {Array} files - Array of file objects
 * @returns {HTMLElement} - Folder UI element
 */
function createFolderUI(folder, files) {
    const folderDiv = document.createElement("div");
    folderDiv.classList.add("mb-4");

    // Folder header with title + buttons
    const headerDiv = document.createElement("div");
    headerDiv.classList.add("d-flex", "justify-content-between", "align-items-center", "mb-2");

    const title = document.createElement("h6");
    title.textContent = folder;
    title.classList.add("fw-bold", "mb-0");

    const buttonGroup = document.createElement("div");

    // Delete button
    const deleteBtn = document.createElement("button");
    deleteBtn.innerHTML = `Delete`;
    deleteBtn.classList.add("btn", "btn-sm", "btn-danger", "me-2", "btn-delete");
    deleteBtn.onclick = () => {
        showNotification(`Delete clicked for ${folder}`, "warning");
        delete_folder(folder);
    };

    // Set Known button
    const setKnownBtn = document.createElement("button");
    setKnownBtn.innerHTML = `Set Known <i class="fa-solid fa-user-plus ms-1"></i>`;
    setKnownBtn.classList.add("btn", "btn-sm", "btn-primary", "btn-unknown");
    setKnownBtn.onclick = () => {
        showNotification(`Set Known clicked for ${folder}`, "info");
        get_list_unknown_students(folder);
        const setKnownModal = new bootstrap.Modal(document.getElementById("modal-set-known"));
        setKnownModal.show();
    };

    buttonGroup.appendChild(deleteBtn);
    buttonGroup.appendChild(setKnownBtn);
    headerDiv.appendChild(title);
    headerDiv.appendChild(buttonGroup);
    folderDiv.appendChild(headerDiv);

    // Add horizontal line below header
    const hr = document.createElement("hr");
    folderDiv.appendChild(hr);

    // File row
    const fileRow = document.createElement("div");
    fileRow.classList.add("d-flex", "flex-wrap", "gap-3");

    // Add image files
    files.forEach(file => {
        if (file.type === "image") {
            // ✅ Create wrapper for image + delete icon
            const imageWrapper = document.createElement("div");
            imageWrapper.classList.add("image-wrapper");
            imageWrapper.style.position = "relative";
            imageWrapper.style.width = "200px";
            imageWrapper.style.height = "200px";

            // Create image element
            const mediaEl = document.createElement("img");
            mediaEl.src = file.url;
            mediaEl.alt = file.filename;
            mediaEl.style.width = "100%";
            mediaEl.style.height = "100%";
            mediaEl.style.objectFit = "cover";
            mediaEl.classList.add("rounded", "shadow");

            // ✅ Create delete icon button
            const deleteIcon = document.createElement("button");
            deleteIcon.innerHTML = '<i class="fas fa-times"></i>';
            deleteIcon.classList.add("image-delete-btn");
            deleteIcon.title = "Delete image";
            deleteIcon.onclick = (e) => {
                e.stopPropagation(); // Prevent any parent click events
                deleteImage(folder, file.filename, imageWrapper);
            };

            // Append image and delete button to wrapper
            imageWrapper.appendChild(mediaEl);
            imageWrapper.appendChild(deleteIcon);
            fileRow.appendChild(imageWrapper);
        }
    });

    folderDiv.appendChild(fileRow);
    return folderDiv;
}

// ✅ Add function to delete individual image
function deleteImage(folderPath, filename, imageWrapper) {
    // ✅ Styled confirmation with SweetAlert2
    Swal.fire({
        title: 'Delete Image?',
        html: `Are you sure you want to delete<br><strong>${filename}</strong>?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
        reverseButtons: true,
        customClass: {
            popup: 'custom-swal-popup',
            title: 'custom-swal-title',
            htmlContainer: 'custom-swal-text'
        }
    }).then((result) => {
        if (!result.isConfirmed) {
            return; // User cancelled
        }

        // Show loading state
        imageWrapper.style.opacity = '0.5';
        imageWrapper.style.pointerEvents = 'none';

        fetch('/api/delete-image-from-folder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                folder: folderPath,
                filename: filename,
                calendarId: sessionId,
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete image');
            }
            return response.json();
        })
        .then(data => {
            console.log('Image deleted successfully:', data);

            // Remove image from UI with animation
            imageWrapper.style.transition = 'all 0.3s';
            imageWrapper.style.transform = 'scale(0)';
            imageWrapper.style.opacity = '0';

            setTimeout(() => {
                imageWrapper.remove();

                // Success message
                Swal.fire({
                    title: 'Deleted!',
                    text: 'Image has been deleted successfully.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            }, 300);
        })
        .catch(error => {
            console.error('Error deleting image:', error);

            // Reset state on error
            imageWrapper.style.opacity = '1';
            imageWrapper.style.pointerEvents = 'auto';

            // Error message
            Swal.fire({
                title: 'Error!',
                text: 'Failed to delete image. Please try again.',
                icon: 'error',
                confirmButtonColor: '#dc3545'
            });
        });
    });
}
// =============================
// FOLDER MANAGEMENT FUNCTIONS
// =============================

/**
 * Delete a folder of unknown student attendance
 * @param {string} folderPath - Path of the folder to delete
 */
function delete_folder(folderPath = "") {
    // ✅ Styled confirmation with SweetAlert2 (same as deleteImage)
    Swal.fire({
        title: 'Delete Folder?',
        html: `Are you sure you want to delete folder<br><strong>${folderPath}</strong>?<br><small class="text-muted">This will delete all images in this folder.</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
        reverseButtons: true,
        customClass: {
            popup: 'custom-swal-popup',
            title: 'custom-swal-title',
            htmlContainer: 'custom-swal-text'
        }
    }).then((result) => {
        if (!result.isConfirmed) {
            return; // User cancelled
        }

        // Find the folder element to show loading state
        const modalBody = document.querySelector("#model-unknown-student .modal-body");
        const folderDivs = modalBody.querySelectorAll('.mb-4');
        let folderDiv = null;

        folderDivs.forEach(div => {
            const title = div.querySelector('h6');
            if (title && title.textContent === folderPath) {
                folderDiv = div;
            }
        });

        // Show loading state
        if (folderDiv) {
            folderDiv.style.opacity = '0.5';
            folderDiv.style.pointerEvents = 'none';
        }

        fetch('/api/delete-unknown-student-attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                folder: folderPath,
                calendarId: sessionId,
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete folder');
            }
            return response.json();
        })
        .then(data => {
            console.log('delete success:', data);

            // ✅ Remove folder from UI with animation
            if (folderDiv) {
                folderDiv.style.transition = 'all 0.3s';
                folderDiv.style.transform = 'scale(0.8)';
                folderDiv.style.opacity = '0';

                setTimeout(() => {
                    folderDiv.remove();

                    // Check if there are any folders left
                    const remainingFolders = modalBody.querySelectorAll('.mb-4');
                    if (remainingFolders.length === 0) {
                        modalBody.innerHTML = '<p class="text-center text-muted py-5">No unknown students found</p>';
                    }

                    // ✅ Success message
                    Swal.fire({
                        title: 'Deleted!',
                        text: 'Folder has been deleted successfully.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }, 300);
            }
        })
        .catch(error => {
            console.error('Error deleting folder:', error);

            // Reset folder state on error
            if (folderDiv) {
                folderDiv.style.opacity = '1';
                folderDiv.style.pointerEvents = 'auto';
            }

            // ✅ Error message
            Swal.fire({
                title: 'Error!',
                text: 'Failed to delete folder. Please try again.',
                icon: 'error',
                confirmButtonColor: '#dc3545'
            });
        });
    });
}

// =============================
// STUDENT MANAGEMENT FUNCTIONS
// =============================

/**
 * Fetch list of unknown students for a folder
 * @param {string} folderPath - Folder path
 */
function get_list_unknown_students(folderPath = "") {
    currentFolder = folderPath;
    fetch(`/api/get-unknown-student-attendance/${sessionId}`)
        .then(res => {
            if (!res.ok) {
                throw new Error("Failed to load unknown students");
            }
            return res.json();
        })
        .then(data => {
            console.log("Unknown Students Data:", data);
            if (data.success && data.students) {
                allStudents = data.students;
                displayStudents();
            } else {
                console.error("No students data found");
                displayNoStudents();
            }
        })
        .catch(err => {
            console.error("Error fetching unknown students:", err);
            displayError();
        });
}

/**
 * Display students with pagination
 */
function displayStudents() {
    const tableBody = document.getElementById('students-table-body');
    const totalStudents = allStudents.length;
    console.log("Total Students:", totalStudents);
    const totalPages = Math.ceil(totalStudents / studentsPerPage);

    // Calculate start and end indices for current page
    const startIndex = (currentPage - 1) * studentsPerPage;
    const endIndex = Math.min(startIndex + studentsPerPage, totalStudents);

    // Get students for current page
    const studentsToShow = allStudents.slice(startIndex, endIndex);

    // Clear existing content
    tableBody.innerHTML = '';

    // Add student rows
    studentsToShow.forEach(student => {
        const row = createStudentRow(student);
        tableBody.appendChild(row);
    });

    // Update pagination
    updatePagination(totalStudents, totalPages);
}



/**
 * Create a table row for a student
 * @param {Object} student - Student object
 * @returns {HTMLElement} - Table row element
 */
function createStudentRow(student) {
    const row = document.createElement('tr');

    // ✅ Escape single quotes in folder path
    const escapedFolder = currentFolder.replace(/'/g, "\\'");

    row.innerHTML = `
        <td class="student-name">${student.name}</td>
        <td class="student-email">${student.email}</td>
        <td>
            <button type="button" class="btn btn-associate"
                    onclick="associateStudent(${student.id}, ${student.attendanceId}, '${escapedFolder}')">
                Associate
            </button>
        </td>
    `;
    return row;
}


/**
 * Associate a student with attendance data
 * @param {number} studentId - Student ID
 * @param {number} attendanceId - Attendance ID
 * @param {string} folder - Folder path (ADDED THIS PARAMETER)
 */


function updatePagination(totalStudents, totalPages) {
    const paginationInfo = document.getElementById('pagination-info');
    const paginationControls = document.getElementById('pagination-controls');

    // Update info text
    const startIndex = (currentPage - 1) * studentsPerPage + 1;
    const endIndex = Math.min(currentPage * studentsPerPage, totalStudents);
    paginationInfo.textContent = `Showing ${startIndex}-${endIndex} of ${totalStudents} students`;

    // Clear existing pagination controls
    paginationControls.innerHTML = '';

    // Don't show pagination if only one page
    if (totalPages <= 1) return;

    // Previous button
    const prevButton = createPaginationButton('Previous', currentPage > 1, () => {
        if (currentPage > 1) {
            currentPage--;
            displayStudents();
        }
    });
    paginationControls.appendChild(prevButton);

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const pageButton = createPaginationButton(i.toString(), true, () => {
            currentPage = i;
            displayStudents();
        }, i === currentPage);
        paginationControls.appendChild(pageButton);
    }

    // Next button
    const nextButton = createPaginationButton('Next', currentPage < totalPages, () => {
        if (currentPage < totalPages) {
            currentPage++;
            displayStudents();
        }
    });
    paginationControls.appendChild(nextButton);
}

/**
 * Create a pagination button
 * @param {string} text - Button text
 * @param {boolean} enabled - Whether the button is enabled
 * @param {Function} onClick - Click handler function
 * @param {boolean} isActive - Whether the button is active
 * @returns {HTMLElement} - Pagination button element
 */
function createPaginationButton(text, enabled, onClick, isActive = false) {
    const li = document.createElement('li');
    li.className = `page-item ${!enabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;

    const button = document.createElement('button');
    button.className = 'page-link';
    button.textContent = text;
    button.disabled = !enabled;

    if (enabled) {
        button.addEventListener('click', onClick);
    }

    li.appendChild(button);
    return li;
}

/**
 * Display message when no students found
 */
function displayNoStudents() {
    const tableBody = document.getElementById('students-table-body');
    tableBody.innerHTML = `
        <tr>
            <td colspan="3" class="text-center text-muted py-4">
                No unknown students found
            </td>
        </tr>
    `;
    document.getElementById('pagination-info').textContent = '';
    document.getElementById('pagination-controls').innerHTML = '';
}

/**
 * Display error message
 */
function displayError() {
    const tableBody = document.getElementById('students-table-body');
    tableBody.innerHTML = `
        <tr>
            <td colspan="3" class="text-center text-danger py-4">
                Error loading students. Please try again.
            </td>
        </tr>
    `;
    document.getElementById('pagination-info').textContent = '';
    document.getElementById('pagination-controls').innerHTML = '';
}

// =============================
// STUDENT ASSOCIATION FUNCTIONS
// =============================

/**
 * Associate a student with attendance data
 * @param {number} studentId - Student ID
 * @param {number} attendanceId - Attendance ID
 */
function associateStudent(studentId, attendanceId, folder) {
    console.log(`Associating student ID: ${studentId}, Attendance ID: ${attendanceId}`);
    console.log(`Folder: ${folder}`);

    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Associating...';
    button.disabled = true;

    fetch('/api/associate-known-student-attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            userId: studentId,
            folder: folder,
            calanderId: sessionId,
            attendanceId: attendanceId
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Association successful:', data);
        if (data.success) {
            button.textContent = 'Associated!';
            button.classList.remove('btn-associate');
            button.classList.add('btn-success');

            // Remove student from list
            setTimeout(() => {
                removeStudentFromList(studentId);

                // ✅ SOLUTION 1: Refresh the unknown students modal
                refreshUnknownStudentsModal();
            }, 1000);
        } else {
            throw new Error(data.error || 'Association failed');
        }
    })
    .catch(error => {
        console.error('Error associating student:', error);
        button.textContent = 'Error!';
        button.classList.remove('btn-associate');
        button.classList.add('btn-danger');

        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('btn-danger');
            button.classList.add('btn-associate');
            button.disabled = false;
        }, 3000);

        alert('Failed to associate student. Please try again.');
    });
}

// ✅ Add this new function to refresh the unknown students modal
function refreshUnknownStudentsModal() {
    fetch(`/api/show-attendance-unknown/${sessionId}`)
        .then(res => {
            if (!res.ok) {
                throw new Error("Failed to load session data");
            }
            return res.json();
        })
        .then(data => {
            const grouped = data["unknownFilesGrouped"];

            // Check if the current folder still exists
            if (!grouped || !grouped[currentFolder]) {
                // Folder was deleted (no more unknown students in it)
                console.log('Folder removed, closing modal');

                // Close the "Set Known" modal
                const setKnownModal = bootstrap.Modal.getInstance(document.getElementById('modal-set-known'));
                if (setKnownModal) {
                    setKnownModal.hide();
                }

                // Update the main unknown students modal
                const modalBody = document.querySelector("#model-unknown-student .modal-body");
                modalBody.innerHTML = "";

                if (!grouped || Object.keys(grouped).length === 0) {
                    modalBody.innerHTML = '<p class="text-center text-muted">No unknown students found</p>';
                } else {
                    for (const folder in grouped) {
                        const folderDiv = createFolderUI(folder, grouped[folder]);
                        modalBody.appendChild(folderDiv);
                    }
                }
            } else {
                // Folder still exists, just update the display
                console.log('Folder still has unknown students');
            }
        })
        .catch(err => {
            console.error("Error refreshing unknown students:", err);
        });
}

/**
 * Remove student from list after successful association
 * @param {number} studentId - Student ID to remove
 */
function removeStudentFromList(studentId) {
    allStudents = allStudents.filter(student => student.id !== studentId);

    // Adjust current page if necessary
    const totalPages = Math.ceil(allStudents.length / studentsPerPage);
    if (currentPage > totalPages && totalPages > 0) {
        currentPage = totalPages;
    }

    // Refresh the display
    displayStudents();
}

// =============================
// ATTENDANCE MANAGEMENT FUNCTIONS
// =============================

/**
 * Reset attendance data
 */
function reset_attendance() {
    fetch(`/reset_attendance_api/${sessionId}`)
        .then(res => {
            if (!res.ok) {
                throw new Error("Failed to reset attendance");
            }
            return res.json();
        })
        .then(data => {
            console.log("Attendance reset successfully");
        })
        .catch(err => {
            console.error("Error resetting attendance:", err);
        });
}

// =============================
// UTILITY FUNCTIONS
// =============================

/**
 * Show notification (placeholder function - implement as needed)
 * @param {string} message - Notification message
 * @param {string} type - Notification type
 */
function showNotification(message, type) {
    // Implementation depends on your notification system
    console.log(`${type.toUpperCase()}: ${message}`);
    // You might use Toast, SweetAlert, or custom notification here
}
</script>